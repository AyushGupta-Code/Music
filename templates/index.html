<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Music + Voice Generator</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 980px; margin: 32px auto; padding: 0 16px; }
      textarea { width: 100%; min-height: 180px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
      label { display: block; font-weight: 600; margin-bottom: 6px; }
      input, select, textarea { width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 10px; }
      .btn { margin-top: 16px; padding: 12px 16px; border-radius: 12px; border: 1px solid #222; background: #111; color: #fff; cursor: pointer; }
      .hint { color: #555; font-size: 13px; margin-top: 6px; }
      .card { border: 1px solid #ddd; border-radius: 16px; padding: 16px; box-shadow: 0 1px 10px rgba(0,0,0,.04); }
      .small { font-size: 13px; color: #444; }
      .hidden { display: none; }
      .muted { color: #666; }
    </style>
  </head>

  <body>
    <h1>Paragraph → Emotion → Music + Voice</h1>
    <p class="small muted">
      Dropdown-only configuration. Voice models are populated dynamically per engine.
      Metrics are saved to <code>metrics/metrics.csv</code> and <code>metrics/metrics.jsonl</code>.
    </p>

    <div class="card">
      <form method="post" action="/generate">
        <label for="paragraph">Paragraph</label>
        <textarea id="paragraph" name="paragraph" placeholder="Paste a paragraph here...">{{ default_paragraph }}</textarea>

        <div class="row3" style="margin-top:16px;">
          <div>
            <label for="music_model">Music Model</label>
            <select id="music_model" name="music_model">
              {% for k, v in music_models.items() %}
                <option value="{{ k }}">{{ k }} ({{ v }})</option>
              {% endfor %}
            </select>
            <div class="hint">Add more in <code>musicgenutil.DEFAULT_MUSIC_MODELS</code>.</div>
          </div>

          <div>
            <label for="duration_s">Music Duration (seconds)</label>
            <input id="duration_s" name="duration_s" type="number" min="2" max="60" step="1" value="8"/>
          </div>

          <div>
            <label for="seed">Seed (optional)</label>
            <input id="seed" name="seed" type="number" placeholder="e.g., 42"/>
          </div>
        </div>

        <div class="row3" style="margin-top:16px;">
          <div>
            <label for="voice_engine">Voice Engine</label>
            <select id="voice_engine" name="voice_engine">
              {% for key, spec in engines.items() %}
                <option value="{{ key }}" {% if key==default_voice_engine %}selected{% endif %}>
                  {{ spec.label }}
                </option>
              {% endfor %}
            </select>
            <div class="hint">Engines appear only if installed/available.</div>
          </div>

          <div>
            <label for="voice_model">Voice Model</label>
            <select id="voice_model" name="voice_model">
              {% for v, lbl in initial_voice_models %}
                <option value="{{ v }}" {% if v==default_voice_model %}selected{% endif %}>{{ lbl }}</option>
              {% endfor %}
            </select>
            <div class="hint">
              MeloTTS: English-only. Coqui: large English catalog. Piper: local .onnx voices.
            </div>
          </div>

          <div>
            <label for="voice_speed">Voice Speed</label>
            <input id="voice_speed" name="voice_speed" type="number" min="0.6" max="1.4" step="0.05" value="1.0"/>
            <div class="hint">Used primarily for MeloTTS.</div>
          </div>
        </div>

        <div class="row3" style="margin-top:16px;">
          <div id="speaker_block">
            <label for="voice_speaker">Melo Speaker</label>
            <select id="voice_speaker" name="voice_speaker">
              <option value="">Auto</option>
              {% for spk in initial_speakers %}
                <option value="{{ spk }}">{{ spk }}</option>
              {% endfor %}
            </select>
            <div class="hint">Lazy-loaded after page render to avoid blocking <code>/</code>.</div>
          </div>

          <div>
            <label for="voice_ratio">Voice Ratio</label>
            <input id="voice_ratio" name="voice_ratio" type="number" min="0.1" max="1.0" step="0.05" value="0.8"/>
          </div>

          <div>
            <label for="music_ratio">Music Ratio</label>
            <input id="music_ratio" name="music_ratio" type="number" min="0.0" max="0.9" step="0.05" value="0.2"/>
          </div>
        </div>

        <button class="btn" type="submit">Generate</button>
      </form>
    </div>

    <script>
      async function loadVoiceModels(engine) {
        const res = await fetch(`/api/voice_models?engine=${encodeURIComponent(engine)}`);
        const items = await res.json();
        const sel = document.getElementById("voice_model");
        sel.innerHTML = "";
        for (const it of items) {
          const opt = document.createElement("option");
          opt.value = it.value;
          opt.textContent = it.label;
          sel.appendChild(opt);
        }
      }

      async function loadMeloSpeakers(language) {
        const res = await fetch(`/api/melo_speakers?language=${encodeURIComponent(language)}`);
        const items = await res.json();

        const sel = document.getElementById("voice_speaker");
        const prev = sel.value;

        sel.innerHTML = "";
        const autoOpt = document.createElement("option");
        autoOpt.value = "";
        autoOpt.textContent = "Auto";
        sel.appendChild(autoOpt);

        for (const spk of items) {
          const opt = document.createElement("option");
          opt.value = spk;
          opt.textContent = spk;
          sel.appendChild(opt);
        }

        // Preserve previous selection if still present
        sel.value = prev;
      }

      function setSpeakerVisibility(engine) {
        const block = document.getElementById("speaker_block");
        if (engine === "melotts") block.classList.remove("hidden");
        else block.classList.add("hidden");
      }

      const engineSel = document.getElementById("voice_engine");
      const modelSel = document.getElementById("voice_model");

      engineSel.addEventListener("change", async () => {
        const engine = engineSel.value;
        setSpeakerVisibility(engine);

        // Update model dropdown based on engine
        await loadVoiceModels(engine);

        // If Melo selected, refresh speakers using selected language (EN in your build)
        if (engine === "melotts") {
          const lang = modelSel.value || "EN";
          try {
            await loadMeloSpeakers(lang);
          } catch (e) {
            console.warn("Failed to load Melo speakers:", e);
          }
        }
      });

      modelSel.addEventListener("change", async () => {
        const engine = engineSel.value;
        if (engine === "melotts") {
          try {
            await loadMeloSpeakers(modelSel.value || "EN");
          } catch (e) {
            console.warn("Failed to load Melo speakers:", e);
          }
        }
      });

      // initial visibility
      setSpeakerVisibility(engineSel.value);

      // NEW: lazy-load Melo speakers after the page renders (prevents blocking GET /)
      window.addEventListener("DOMContentLoaded", async () => {
        if (engineSel.value === "melotts") {
          try {
            await loadMeloSpeakers(modelSel.value || "EN");
          } catch (e) {
            // keep page usable even if speaker fetch fails
            console.warn("Failed to load Melo speakers:", e);
          }
        }
      });
    </script>
  </body>
</html>
